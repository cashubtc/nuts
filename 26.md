# NUT-26: Onchain

`optional`

`depends on: NUT-04 NUT-05 NUT-20`

---

This document describes minting and melting ecash with the `onchain` payment method, which uses Bitcoin onchain transactions. It is an extension of [NUT-04][04] and [NUT-05][05] which cover the protocol steps of minting and melting ecash shared by any supported payment method.

## Mint Quote

For the `onchain` method, the wallet includes the following specific `PostMintQuoteOnchainRequest` data:

```json
{
  "unit": <str_enum[UNIT]>,
  "pubkey": <str>
}
```

> **Note:** While a pubkey is optional as per [NUT-20][20] for [NUT-04][04] it is required in this NUT and the mint **MUST NOT** issue a mint quote if one is not included.

> **Privacy:** To prevent linking multiple mint quotes together, wallets **SHOULD** generate a unique public key for each mint quote request.

The mint responds with a `PostMintQuoteOnchainResponse`:

```json
{
  "quote": <str>,
  "request": <str>,
  "unit": <str_enum[UNIT]>,
  "expiry": <int|null>,
  "pubkey": <str>,
  "amount_paid": <int>,
  "amount_issued": <int>,
  "amount_unconfirmed": <int>
}
```

Where:

- `quote` is the quote ID
- `request` is the Bitcoin address to send funds to
- `expiry` is the Unix timestamp until which the mint quote is valid
- `pubkey` is the public key from the request
- `amount_paid` is the total confirmed amount paid to the mint via the onchain address
- `amount_issued` is the amount of ecash that has been issued for the given mint quote
- `amount_unconfirmed` is the amount that has been received but is waiting for sufficient confirmations

### Example

**Request** with curl:

```bash
curl -X POST http://localhost:3338/v1/mint/quote/onchain -d \
'{"unit": "sat", "pubkey": "03d56ce4e446a85bbdaa547b4ec2b073d40ff802831352b8272b7dd7a4de5a7cac"}' \
-H "Content-Type: application/json"
```

**Response**:

```json
{
  "quote": "DSGLX9kevM...",
  "request": "bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh",
  "unit": "sat",
  "expiry": 1701704757,
  "pubkey": "03d56ce4e446a85bbdaa547b4ec2b073d40ff802831352b8272b7dd7a4de5a7cac",
  "amount_paid": 0,
  "amount_issued": 0,
  "amount_unconfirmed": 0
}
```

Check quote state:

```bash
curl -X GET http://localhost:3338/v1/mint/quote/onchain/DSGLX9kevM...
```

After sending â‚¿100,000 to the address (transaction detected but unconfirmed):

```json
{
  "quote": "DSGLX9kevM...",
  "request": "bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh",
  "unit": "sat",
  "expiry": 1701704757,
  "pubkey": "03d56ce4e446a85bbdaa547b4ec2b073d40ff802831352b8272b7dd7a4de5a7cac",
  "amount_paid": 0,
  "amount_issued": 0,
  "amount_unconfirmed": 100000
}
```

Once the transaction has sufficient confirmations:

```json
{
  "quote": "DSGLX9kevM...",
  "request": "bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh",
  "unit": "sat",
  "expiry": 1701704757,
  "pubkey": "03d56ce4e446a85bbdaa547b4ec2b073d40ff802831352b8272b7dd7a4de5a7cac",
  "amount_paid": 100000,
  "amount_issued": 0,
  "amount_unconfirmed": 0
}
```

Minting tokens:

```bash
curl -X POST https://mint.host:3338/v1/mint/onchain -H "Content-Type: application/json" -d \
'{
  "quote": "DSGLX9kevM...",
  "outputs": [
    {
      "amount": 50000,
      "id": "009a1f293253e41e",
      "B_": "035015e6d7ade60ba8426cefaf1832bbd27257636e44a76b922d78e79b47cb689d"
    },
    {
      "amount": 50000,
      "id": "009a1f293253e41e",
      "B_": "0288d7649652d0a83fc9c966c969fb217f15904431e61a44b14999fabc1b5d9ac6"
    }
  ]
}'
```

Response:

```json
{
  "signatures": [
    {
      "id": "009a1f293253e41e",
      "amount": 50000,
      "C_": "0224f1c4c564230ad3d96c5033efdc425582397a5a7691d600202732edc6d4b1ec"
    },
    {
      "id": "009a1f293253e41e",
      "amount": 50000,
      "C_": "0277d1de806ed177007e5b94a8139343b6382e472c752a74e99949d511f7194f6c"
    }
  ]
}
```

## Multiple Deposits

Unlike lightning payments, onchain addresses can receive multiple payments, allowing the wallet to make multiple deposits for one quote. The wallet can call the check onchain endpoint, where the mint will return the `PostMintQuoteOnchainResponse` including `amount_paid`, `amount_issued`, and `amount_unconfirmed`. The difference between `amount_paid` and `amount_issued` represents how much the wallet can mint by calling the mint endpoint.

## Mint Settings

A `confirmations` option **SHOULD** be set to indicate the minimum depth in the blockahin for a transaction to be considered confirmed.

### Example `MintMethodSetting`

```json
{
  "method": "onchain",
  "unit": <str>,
  "min_amount": <int|null>,
  "max_amount": <int|null>,
  "options": {
    "confirmations": <int>
  }
}
```

## Melt Quote

For the `onchain` method, the wallet includes the following specific `PostMeltQuoteOnchainRequest` data:

```json
{
  "request": <str>,
  "unit": <str_enum[UNIT]>,
  "amount": <int>
}
```

Here, `request` is the Bitcoin address to send to, `unit` is the unit the wallet would like to pay with, and `amount` is the amount to send in the specified unit.

The mint responds with a `PostMeltQuoteOnchainResponse`:

```json
{
  "quote": <str>,
  "request": <str>,
  "amount": <int>,
  "unit": <str_enum[UNIT]>,
  "fee_reserve": <int>,
  "state": <str_enum[STATE]>,
  "expiry": <int>,
  "transaction_id": <str|null>
}
```

Where `fee_reserve` is the additional fee reserve required to broadcast the transaction. The mint expects the wallet to include `Proofs` of _at least_ `total_amount = amount + fee_reserve + fee` where `fee` is calculated from the keyset's `input_fee_ppk` as described in [NUT-02][02].

`state` is an enum string field with possible values `"UNPAID"`, `"PENDING"`, `"PAID"`:

- `"UNPAID"` means that the transaction has not been broadcast yet.
- `"PENDING"` means that the transaction has been broadcast but not yet confirmed.
- `"PAID"` means that the transaction has been confirmed.

`transaction_id` is the Bitcoin transaction ID, present once the transaction has been broadcast.

### Melting Tokens

For the `onchain` method, the wallet can include an optional `outputs` field in the melt request to receive change for overpaid transaction fees (see [NUT-08][08]):

```json
{
  "quote": <str>,
  "inputs": <Array[Proof]>,
  "outputs": <Array[BlindedMessage]> // Optional
}
```

If the `outputs` field is included and there is excess from the `fee_reserve`, the mint will respond with a `change` field containing blind signatures for the overpaid amount:

```json
{
  "quote": <str>,
  "request": <str>,
  "amount": <int>,
  "unit": <str_enum[UNIT]>,
  "fee_reserve": <int>,
  "state": <str_enum[STATE]>,
  "expiry": <int>,
  "transaction_id": <str>,
  "change": <Array[BlindSignature]> // Present if outputs were included and there's change
}
```

### Example

**Melt quote request**:

```bash
curl -X POST https://mint.host:3338/v1/melt/quote/onchain -d \
'{"request": "bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh", "unit": "sat", "amount": 100000}'
```

**Melt quote response**:

```json
{
  "quote": "TRmjduhIsPxd...",
  "request": "bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh",
  "amount": 100000,
  "unit": "sat",
  "fee_reserve": 2000,
  "state": "UNPAID",
  "expiry": 1701704757
}
```

Check quote state:

```bash
curl -X GET http://localhost:3338/v1/melt/quote/onchain/TRmjduhIsPxd...
```

**Melt request**:

```bash
curl -X POST https://mint.host:3338/v1/melt/onchain -d \
'{"quote": "TRmjduhIsPxd...", "inputs": [...]}'
```

**Successful melt response** (transaction broadcast):

```json
{
  "quote": "TRmjduhIsPxd...",
  "request": "bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh",
  "amount": 100000,
  "unit": "sat",
  "fee_reserve": 2000,
  "state": "PENDING",
  "expiry": 1701704757,
  "transaction_id": "3b7f3b85c5f1a3c4d2b8e9f6a7c5d8e9f1a2b3c4d5e6f7a8b9c1d2e3f4a5b6c7"
}
```

**Final confirmed state**:

```json
{
  "quote": "TRmjduhIsPxd...",
  "request": "bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh",
  "amount": 100000,
  "unit": "sat",
  "fee_reserve": 2000,
  "state": "PAID",
  "expiry": 1701704757,
  "transaction_id": "3b7f3b85c5f1a3c4d2b8e9f6a7c5d8e9f1a2b3c4d5e6f7a8b9c1d2e3f4a5b6c7"
}
```

### Example `MeltMethodSetting`

```json
{
  "method": "onchain",
  "unit": <str>,
  "min_amount": <int|null>,
  "max_amount": <int|null>,
}
```

[02]: 02.md
[04]: 04.md
[05]: 05.md
[08]: 08.md
[20]: 20.md
