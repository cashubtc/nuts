# NUT-04: Mint tokens

`mandatory`

`used in: NUT-20`

---

Minting tokens is a two-step process: requesting a mint quote and minting new tokens. This document describes the general flow that applies to all payment methods, with specifics for each supported payment method provided in dedicated sections.

## General Flow

The minting process follows these steps for all payment methods:

1. The wallet requests a mint quote for a specific `amount` and `unit` to mint, specifying the payment `method`
2. The mint responds with a quote that includes a `quote` id and a payment `request`
3. The user pays the `request` using the specified payment method
4. The wallet then requests minting of new tokens with the mint, including the `quote` id and new `outputs`
5. The mint verifies payment and returns blind signatures

## Common Request and Response Formats

### Mint Quote

To request a mint quote, the wallet of `Alice` makes a `POST /v1/mint/quote/{method}` request where `method` is the payment method requested (e.g., `bolt11`, `bolt12`, etc.).

```http
POST https://mint.host:3338/v1/mint/quote/{method}
```

Depending on the payment method, the request structure may vary, but all methods will include at minimum:

```json
{
  "amount": <int>,
  "unit": <str_enum[UNIT]>
  // Additional method-specific fields may be required
}
```

The mint `Bob` responds with a quote that includes some common fields for all methods:

```json
{
  "quote": <str>,
  "amount": <int>,
  "unit":  <str_enum[UNIT]>,
  "state": <str_enum[STATE]>,
  "expiry": <int>
  // Additional method-specific fields will be included
}
```

Where `quote` is the quote ID, `expiry` is the Unix timestamp until which the mint quote is valid, and `amount` and `unit` correspond to the values provided in the request.

`state` is an enum string field with possible values `"UNPAID"`, `"PAID"`, `"ISSUED"`:

- `"UNPAID"` means that the quote's request has not been paid yet.
- `"PAID"` means that the request has been paid.
- `"ISSUED"` means that the quote has already been issued.

> [!CAUTION]
>
> `quote` is a **unique and random** id generated by the mint to internally look up the payment state. `quote` **MUST** remain a secret between user and mint and **MUST NOT** be derivable from the payment request. A third party who knows the `quote` ID can front-run and steal the tokens that this operation mints.

### Check Mint Quote State

To check whether a mint quote has been paid, the wallet makes a `GET /v1/mint/quote/{method}/{quote_id}`.

```http
GET https://mint.host:3338/v1/mint/quote/{method}/{quote_id}
```

The mint responds with the same structure as the initial quote response.

### Minting Tokens

After requesting a mint quote and paying the request, the wallet proceeds with minting new tokens by calling the `POST /v1/mint/{method}` endpoint.

```http
POST https://mint.host:3338/v1/mint/{method}
```

The wallet includes the following common data in its request:

```json
{
  "quote": <str>,
  "outputs": <Array[BlindedMessage]>
}
```

with the `quote` being the quote ID from the previous step and `outputs` being `BlindedMessages` (see [NUT-00][00]) that the wallet requests signatures on, whose sum is `amount` as requested in the quote.

The mint then responds with:

```json
{
  "signatures": <Array[BlindSignature]>
}
```

where `signatures` is an array of blind signatures on the outputs.

## Payment Method: BOLT11

This section describes the specifics for the `bolt11` payment method, which uses Lightning Network invoices.

### Mint Quote - BOLT11

For the `bolt11` method, the wallet includes the following specific `PostMintQuoteBolt11Request` data:

```json
{
  "amount": <int>,
  "unit": <str_enum[UNIT]>,
  "description": <str> // Optional
}
```

The mint responds with a `PostMintQuoteBolt11Response`:

```json
{
  "quote": <str>,
  "request": <str>, // The bolt11 invoice to pay
  "amount": <int>,
  "unit":  <str_enum[UNIT]>,
  "state": <str_enum[STATE]>,
  "expiry": <int>
}
```

### Example - BOLT11

Request with curl:

```bash
curl -X POST http://localhost:3338/v1/mint/quote/bolt11 -d '{"amount": 10, "unit": "sat"}' -H "Content-Type: application/json"
```

Response:

```json
{
  "quote": "DSGLX9kevM...",
  "request": "lnbc100n1pj4apw9...",
  "amount": 10,
  "unit": "sat",
  "state": "UNPAID",
  "expiry": 1701704757
}
```

Check quote state:

```bash
curl -X GET http://localhost:3338/v1/mint/quote/bolt11/DSGLX9kevM...
```

Minting tokens:

```bash
curl -X POST https://mint.host:3338/v1/mint/bolt11 -H "Content-Type: application/json" -d \
'{
  "quote": "DSGLX9kevM...",
  "outputs": [
    {
      "amount": 8,
      "id": "009a1f293253e41e",
      "B_": "035015e6d7ade60ba8426cefaf1832bbd27257636e44a76b922d78e79b47cb689d"
    },
    {
      "amount": 2,
      "id": "009a1f293253e41e",
      "B_": "0288d7649652d0a83fc9c966c969fb217f15904431e61a44b14999fabc1b5d9ac6"
    }
  ]
}'
```

Response:

```json
{
  "signatures": [
    {
      "id": "009a1f293253e41e",
      "amount": 2,
      "C_": "0224f1c4c564230ad3d96c5033efdc425582397a5a7691d600202732edc6d4b1ec"
    },
    {
      "id": "009a1f293253e41e",
      "amount": 8,
      "C_": "0277d1de806ed177007e5b94a8139343b6382e472c752a74e99949d511f7194f6c"
    }
  ]
}
```

## Adding New Payment Methods

To add a new payment method (e.g., BOLT12), implement the following:

1. Define the method-specific request and response structures following the pattern above
2. Implement the three required endpoints: quote request, quote check, and mint execution
3. Update the settings to include the new method

## Settings

The settings for this NUT indicate the supported method-unit pairs for minting. They are part of the info response of the mint ([NUT-06][06]) which reads:

```json
{
  "4": {
    "methods": [
      <MintMethodSetting>,
      ...
    ],
    "disabled": <bool>
  }
}
```

`MintMethodSetting` indicates supported `method` and `unit` pairs and additional settings of the mint. `disabled` indicates whether minting is disabled.

`MintMethodSetting` is of the form:

```json
{
  "method": <str>,
  "unit": <str>,
  "min_amount": <int|null>,
  "max_amount": <int|null>,
  "description": <bool|null>,
  // Additional method-specific settings can be added here
}
```

`min_amount` and `max_amount` indicate the minimum and maximum amount for an operation of this method-unit pair.

Example `MintMethodSetting` for BOLT11:

```json
{
  "method": "bolt11",
  "unit": "sat",
  "min_amount": 0,
  "max_amount": 10000,
  "description": true
}
```

## Unblinding Signatures

Upon receiving the `BlindSignatures` from the mint, the wallet unblinds them to generate `Proofs` (using the blinding factor `r` and the mint's public key `K`, see BDHKE [NUT-00][00]). The wallet then stores these `Proofs` in its database.

[00]: 00.md
[01]: 01.md
[02]: 02.md
[03]: 03.md
[04]: 04.md
[05]: 05.md
[06]: 06.md
[07]: 07.md
[08]: 08.md
[09]: 09.md
[10]: 10.md
[11]: 11.md
[12]: 12.md