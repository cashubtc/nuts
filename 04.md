# NUT-04: Minting tokens

`mandatory`

---

Minting tokens is a two-step process: requesting a mint quote and minting new tokens.

1. The wallet **MUST** first request a mint quote by specifying the `amount`, `unit`, and payment `method`. 
   - The mint **MUST** respond with a `quote` ID and a payment `request` for valid requests.
2. After payment, the wallet **MUST** initiate the minting process by sending the `quote` ID and `outputs` in a second request.

---

## Mint Quote

To request a mint quote, the wallet **MUST** send a `POST /v1/mint/quote/{method}` request. The `method` specifies the payment method (e.g., `bolt11`).

### Request Endpoint

```http
POST https://mint.host:3338/v1/mint/quote/{method}
```

### Request Body

The request body **MUST** include the following fields:

```json
{
  "amount": <int>,
  "unit": <str>,
  "opts": <obj|null>
}
```

- `amount`: The requested amount to mint.
- `unit`: The unit of the amount.
- `opts`: Options specific to the payment method.

### Response

The mint **MUST** respond with a `PostMintQuoteResponse`:

```json
{
  "quote": <str>,
  "request": <str>,
  "state": <str_enum[STATE]>,
  "expiry": <int|null>
}
```

- `quote`: A unique ID for the quote.
- `request`: The payment request.
- `state`: The current state of the quote (`UNPAID`, `PAID`, or `ISSUED`).
- `expiry`: The expiration timestamp for the quote (or `null` for quotes without expiration).

The wallet **MUST** store the `amount` and `quote` ID in its database for use during token minting after payment.

---

### Security Note

The `quote` ID **MUST** be unique and secret. It **MUST NOT** be derivable from the payment request. Leaking this ID allows third parties to steal tokens.

---

### Example: Requesting a Quote

**Request:**

```bash
curl -X POST https://mint.host:3338/v1/mint/quote/{method} \
-d '{"amount": 10, "unit": "sat"}' \
-H "Content-Type: application/json"
```

**Response:**

```json
{
  "quote": "DSGLX9kevM...",
  "request": "lnbc100n1pj4apw9...",
  "state": "UNPAID",
  "expiry": 1701704757
}
```

---

## Checking Mint Quote State

To check whether a mint quote has been paid, the wallet **MUST** send a `GET /v1/mint/quote/{method}/{quote_id}` request.

### Example: Checking Quote State

**Request:**

```bash
curl -X GET https://mint.host:3338/v1/mint/quote/{method}/{quote_id}
```

**Response:**

```json
{
  "quote": "DSGLX9kevM...",
  "request": "lnbc100n1pj4apw9...",
  "state": "UNPAID",
  "expiry": 1701704757
}
```

---

## Minting Tokens

After completing the payment, the wallet **MUST** send a `POST /v1/mint/{method}` request to mint tokens.

### Request Endpoint

```http
POST https://mint.host:3338/v1/mint/{method}
```

### Request Body

The request body **MUST** include:

```json
{
  "quote": <str>,
  "outputs": <Array[BlindedMessage]>
}
```

- `quote`: The quote ID.
- `outputs`: Blinded messages (see [NUT-00](00.md)) for the requested amount.

### Response

The mint **MUST** respond with a `PostMintResponse`:

```json
{
  "signatures": <Array[BlindSignature]>
}
```

- `signatures`: Blind signatures for the outputs.

---

### Example: Minting Tokens

**Request:**

```bash
curl -X POST https://mint.host:3338/v1/mint/{method} \
-H "Content-Type: application/json" \
-d '{
  "quote": "DSGLX9kevM...",
  "outputs": [
    {
      "amount": 8,
      "id": "009a1f293253e41e",
      "B_": "035015e6d7ade60ba8426cefaf1832bbd27257636e44a76b922d78e79b47cb689d"
    },
    {
      "amount": 2,
      "id": "009a1f293253e41e",
      "B_": "0288d7649652d0a83fc9c966c969fb217f15904431e61a44b14999fabc1b5d9ac6"
    }
  ]
}'
```

**Response:**

```json
{
  "signatures": [
    {
      "id": "009a1f293253e41e",
      "amount": 2,
      "C_": "0224f1c4c564230ad3d96c5033efdc425582397a5a7691d600202732edc6d4b1ec"
    },
    {
      "id": "009a1f293253e41e",
      "amount": 8,
      "C_": "0277d1de806ed177007e5b94a8139343b6382e472c752a74e99949d511f7194f6c"
    }
  ]
}
```

If the payment is incomplete, the mint **MUST** return an error. The wallet **SHOULD** retry until the payment is completed.

---

### Unblinding Signatures

After receiving blind signatures, the wallet **MUST** unblind them to generate `Proofs`. This involves the blinding factor `r` and the mint's public key `K` (see BDHKE in [NUT-00](00.md)).

The wallet **MUST** store the `Proofs` in its database:

```json
[
  {
    "id": "009a1f293253e41e",
    "amount": 2,
    "secret": "407915bc212be61a77e3e6d2aeb4c727980bda51cd06a6afc29e2861768a7837",
    "C": "02bc9097997d81afb2cc7346b5e4345a9346bd2a506eb7958598a72f0cf85163ea"
  },
  {
    "id": "009a1f293253e41e",
    "amount": 8,
    "secret": "fe15109314e61d7756b0f8ee0f23a624acaa3f4e042f61433c728c7057b931be",
    "C": "029e8e5050b890a7d6c0968db16bc1d5d5fa040ea1de284f6ec69d61299f671059"
  }
]
```

## Settings

The mint's [NUT-06](06.md) settings **MUST** indicate supported method-unit pairs for minting. It **MUST** also specify whether minting is disabled.

```json
{
  "4": {
    "methods": [
      <MintMethodSetting>,
      ...
    ],
    "disabled": <bool>
  }
}
```

`MintMethodSetting` indicates supported `method` and `unit` pairs. The `disabled` field indicates whether this minting is disabled. The `min_amount` and `max_amount` fields indicate the minimum and maximum amount for an operation of this method-unit pair.

```json
{
  "method": <str>,
  "unit": <str>,
  "min_amount": <int|null>,
  "max_amount": <int|null>,
}
```

Example `MintMethodSetting`:

```json
{
  "method": "bolt11",
  "unit": "sat",
  "min_amount": 0,
  "max_amount": 10000,
}
```

# Well-Known Payment Methods
- [bolt11](20.md)
