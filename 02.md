NUT-02: Keysets and keyset ID
==========================

`mandatory` `author: calle`

---

A keyset is a set of public keys that the mint `Bob` generates and shares with its users. It refers to the set of public keys that each correspond to the amount values that the mint supports (e.g. 1, 2, 4, 8, ...) respectively.

## Requesting mint keyset IDs

A mint can have multiple keysets at the same time but **MUST** have only one *current* keyset (see [NUT-01][01]). Tokens from all other keysets are still accepted but must be redeemed for tokens from only the active keyset.

A wallet can ask the mint for all active keyset IDs via the `GET /keysets` endpoint. A wallet **CAN** request the list of active keyset IDs from the mint upon startup and, if it does so, **MUST** choose only tokens from its database that have a keyset ID supported by the mint to interact with it.

This is useful in the case a wallet interacts with multiple mints. That way, a wallet always knows which tokens it can use with the mint it is currently interacting with. It also helps wallets to determine whether the mint has rotated to a new current keyset and whether it should recycle all tokens from older keysets to the current one.

## Example

Request of `Alice`:

```http
GET https://mint.host:3338/keysets
```

With curl:

```bash
curl -X GET https://mint.host:3338/keysets
```

Response of `Bob`:

```json
{
  "keysets": [
    "L3zxxRB/I8uE",
    "DSAl9nvvyfva",
    ...
  ]
}
```

**Note:** The ordering of the entries in the `keysets` field of the response should not be relied on to assume which keyset ID is the most recent one! For a wallet to be sure which keyset is the most recent one, it should request the keys themselves (see [NUT-01][01]) and then compute the keyset ID.

### Mints: Generating a keyset

A keyset is generated by the mint by a single seed `s` from which the private keys `k_i` are derived, with `i` being the index of the amount value. The derivation for the elements `k_i` goes like this:

```python
for i in range(MAX_ORDER):
	k_i = HASH_SHA256(s + D + i)[:32]
```

Here, `MAX_ORDER` refers to the order of the maximum token value that the mint supports, i.e., `2^MAX_ORDER`. Typically, `MAX_ORDER = 64`. `D` refers to a derivation path that is chosen by the mint. The derivation path can be used to rotate keys over time or to service multiple parallel mints with a single instance. `i` is the string representation of the index of the amount value, i.e., `0`, `1`, and so on.

A `MIN_ORDER` can be optionally defined to support decimal values for tokens. These token amounts are defined as decimal value increments to `10^-(MIN_ORDER)`. So for example a `MIN_ORDER` of 3 would have representation values of `0.1`, `0.01`, and `0.001`. The public keys for the `MIN_ORDER` would be allocated to the latter elements of the list of size '`MAX_ORDER`. In the case of `MAX_ORDER=64` and `MIN_ORDER=3` then `[0,1,3,...]`, where `i is 0 to (MAX_ORDER-MIN_ORDER)` and the elements`[...,61,62,63]` would be decimal token where `j = (MAX_ORDER-MIN_ORDER) to MAX_ORDER -1`

## Keyset ID

A keyset ID is an identifier for a specific keyset. It can be derived by anyone who knows the set of public keys of a mint. The keyset ID **CAN** be stored in a Cashu token [TODO: Link to definition of token] such that the token can be used to identify which mint or keyset it was generated from. 

### Storing the keyset ID in a token

A wallet can use the keyset ID in a token to recognize a mint it was issued by. For example, a wallet might store the `MINT_URL` together with the `keyset_id` in its database the first time it receives a keyset from that mint. That way, a wallet can know which mint to contact when it receives a token with a `keyset_id` of a mint that it has interacted with before.

Note: V3 tokens (see [NUT-00][00]) include the `MINT_URL` to enable the first contact when a wallet recieves a token from a mint it has never met before.

### Deriving the keyset ID

The mint and the wallets of its users can derive a keyset ID from the keyset of the mint. To derive the keyset ID of a keyset, execute the following steps:

```
1 - sort keyset by amount
2 - concatenate all (sorted) public keys to one string
3 - HASH_SHA256 the concatenated public keys
4 - take the first 12 characters of the hash
```

An example implementation in Python:

```python
def derive_keyset_id(keys: Dict[int, PublicKey]):
	"""Deterministic derivation keyset_id from set of public keys."""
	sorted_keys = dict(sorted(keys.items()))
	pubkeys_concat = "".join([p.serialize().hex() for _, p in sorted_keys.items()])
	return base64.b64encode(
	hashlib.sha256((pubkeys_concat).encode("utf-8")).digest()
	).decode()[:12]
```

## Requesting public keys for a specific keyset
To receive the public keys of a specific (old) keyset, a wallet can call the `GET /keys/{idBase64Urlsafe}` where `idBase64Urlsafe` is the [URL-safe](https://datatracker.ietf.org/doc/html/rfc3548#section-4) encoded keyset ID. 

**URL-safe encoding:** That means that the requesting wallet must replace all `/` characters with `_` and all `-` characters with `+` before sending the request. The receiving mint must replace these characters in opposite direction to further process the request (for example, before looking up the keys in its database). 

## Example

Request of `Alice`:

Note that we are requesting the keys for the keyset `L3zxxRB/I8uE` in this example but need to make the request in a URL-safe way.

```http
GET https://mint.host:3338/keys/L3zxxRB_I8uE
```

With curl:

```bash
curl -X GET https://mint.host:3338/keys/L3zxxRB_I8uE
```

Response of `Bob` (similar to [NUT-01][01]):

```json
{
  "1": "03a40f20667ed53513075dc51e715ff2046cad64eb68960632269ba7f0210e38bc",
  "2": "03fd4ce5a16b65576145949e6f99f445f8249fee17c606b688b504a849cdc452de",
  "4": "02648eccfa4c026960966276fa5a4cae46ce0fd432211a4f449bf84f13aa5f8303",
  "8": "02fdfd6796bfeac490cbee12f778f867f0a2c68f6508d17c649759ea0dc3547528",
  ...
}
```

Note that the mint needs to convert the URL-safe id back from `L3zxxRB_I8uE` to `L3zxxRB/I8uE` before it can look up the keys and respond to the request.

[00]: 00.md
[01]: 01.md
[02]: 02.md
[03]: 03.md
[04]: 04.md
[05]: 05.md
[06]: 06.md
[07]: 07.md
[08]: 08.md
[09]: 09.md
[10]: 10.md
[11]: 11.md
[12]: 12.md
[13]: 13.md
[14]: 14.md
[15]: 15.md
[16]: 16.md
[17]: 17.md
[18]: 18.md
[19]: 19.md
[20]: 20.md