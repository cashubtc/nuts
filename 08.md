# NUT-08: Fee Return for Overpayment

`optional`

`depends on: NUT-05`

This document describes how overpaid fees are handled during payments and extends [NUT-05](05.md), which describes the process of melting tokens (i.e., making a payment). Due to the unpredictability of payment network fees (e.g., Lightning network), a wallet may overpay fees. To address this, the wallet provides _blank outputs_ that allow the mint to return overpaid fees. These blank outputs are blinded messages with an undetermined value, which the mint assigns after calculating the overpaid amount.

---

## Description

Before initiating a melt, the wallet generates a number of _blank outputs_. These are similar to blinded messages but do not yet carry a value. The number of required blank outputs is calculated as:

```python
def calculate_blank_outputs(fee_reserve: int) -> int:
    assert fee_reserve >= 0, "Fee reserve must be non-negative."
    if fee_reserve == 0:
        return 0
    return max(math.ceil(math.log2(fee_reserve)), 1)
```

The blank outputs ensure the mint can efficiently return overpaid fees by assigning values derived from powers of two (as described in [NUT-00](00.md)). If no fees are overpaid (`fee_reserve = actual_fees`), the mint does not return any blank outputs.

---

### Wallet Workflow

1. **Request Fee Reserve**  
   The wallet requests a melt quote using `POST /v1/melt/quote/{method}` (see [NUT-05](05.md)). This quote includes the `fee_reserve` required for the payment.

2. **Generate Blank Outputs**  
   The wallet calculates the number of blank outputs based on the `fee_reserve` and generates blinded messages to include in the payment request.

3. **Perform Payment**  
   The wallet submits the payment request, including:
   - `inputs` that satisfy `amount + fee_reserve`
   - The original `quote`
   - The blank `outputs` for potential overpaid fees.

4. **Receive Fee Return**  
   If fees are overpaid (`fee_reserve > actual_fees`), the mint assigns values to the blank outputs and returns them as `BlindSignatures` in the response.

---

### Mint Workflow

1. **Calculate Overpaid Fees**  
   Upon receiving a payment request with blank outputs, the mint calculates the overpaid fees (`fee_reserve - actual_fees`).

2. **Assign Values to Blank Outputs**  
   The mint decomposes the overpaid amount into powers of two and assigns these values to the blank outputs. Only outputs with non-zero values are retained.

3. **Return Blind Signatures**  
   The mint generates `BlindSignatures` for the assigned values and returns them to the wallet in the response.

---

## API Changes

### Payment Request

The wallet includes blank outputs in the melt request:

```http
POST https://mint.host:3338/v1/melt/{method}
```

#### Request Body

```json
{
  "quote": <str>,
  "inputs": <Array[Proof]>,
  "outputs": <Array[BlindedMessage]>
}
```

- `quote`: The melt quote ID.
- `inputs`: Proofs for `amount + fee_reserve`.
- `outputs`: Blank outputs for overpaid fees.

---

### Payment Response

The mint returns any overpaid fees as part of the response:

```json
{
  "quote": <str>,
  "state": <str_enum[STATE]>,
  "payment_preimage": <str|null>,
  "change": <Array[BlindSignature]>
}
```

- `quote`: The quote ID.
- `state`: The payment state (`PAID`, `PENDING`, `UNPAID`).
- `payment_preimage`: Payment preimage (if applicable).
- `change`: Blind signatures for overpaid fees.

---

## Example: Wallet Request

The wallet submits a melt request:

```bash
curl -X POST https://mint.host:3338/v1/melt/{method} -d \
'{
  "quote": "od4CN5smMMS3K3QVHkbGGNCTxfcAIyIXeq8IrfhP",
  "inputs": [
    {
      "amount": 1000,
      "id": "009a1f293253e41e",
      "secret": "429700b812a58436be2629af8731a31a37fce54dbf8cbbe90b3f8553179d23f5",
      "C": "03b01869f528337e161a6768b480fcf9f75fd248b649c382f5e352489fd84fd011"
    }
  ],
  "outputs": [
    {
      "amount": 1,
      "id": "009a1f293253e41e",
      "B_": "03327fc4fa333909b70f08759e217ce5c94e6bf1fc2382562f3c560c5580fa69f4"
    }
  ]
}'
```

---

## Example: Mint Response

The mint responds with assigned values for overpaid fees:

```json
{
  "quote": "od4CN5smMMS3K3QVHkbGGNCTxfcAIyIXeq8IrfhP",
  "state": "PAID",
  "change": [
    {
      "id": "009a1f293253e41e",
      "amount": 512,
      "C_": "03c668f551855ddc792e22ea61d32ddfa6a45b1eb659ce66e915bf5127a8657be0"
    }
  ]
}
```

## Mint Info Setting

The [NUT-06][06.md] `MintMethodSetting` indicates support for this feature:

```json
{
  "8": {
    "supported": true
  }
}
```