NUT-00: Notation and Models
==========================

`mandatory` `author: calle`

---

- Sending user: `Alice`
- Receiving user: `Carol`
- Mint: `Bob`

## Bob (mint)

- `k` private key of mint (one for each amount)
- `K` public key of mint
- `Q` promise (blinded signature)

## Alice (user)

- `x` random string (secret message), corresponds to point `Y` on curve
- `r` private key (blinding factor)
- `T` blinded message
- `Z` proof (unblinded signature)

# Blind Diffie-Hellmann key exchange (BDHKE)

- Mint `Bob` publishes public key `K = kG` 
- `Alice` picks secret `x` and computes `Y = hash_to_curve(x)`
- `Alice` sends to `Bob`: `B_ = Y + rG` with `r` being a random blinding factor (**blinding**)
- `Bob` sends back to `Alice` blinded key: `C_ = kB_` (these two steps are the DH key exchange) (**signing**)
- `Alice` can calculate the unblinded key as `C_ - rK = kY + krG - krG = kY = C` (**unblinding**)
- Alice can take the pair `(x, C)` as a token and can send it to `Carol`.
- `Carol` can send `(x, C)` to `Bob` who then checks that `k*hash_to_curve(x) == C` (**verification**), and if so treats it as a valid spend of a token, adding `x`  to the list of spent secrets.

## 0.1 - Models

### `BlindedMessage`

An encrypted ("blinded") secret and an amount is sent from `Alice` to `Bob` for [minting tokens][04] or for [splitting tokens][06]. A `BlindedMessage` is also called an `output`.

```json
{
  "amount": int,
  "B_": hex_str
}
```

 `amount` is the value of the requested token and `B_` is the encrypted secret message generated by `Alice`. An array `[BlindedMessage]` is also referred to as `BlindedMessages`.

### `BlindedSignature`

A signature on the `BlindedMessage` is sent from `Bob` to `Alice` after [minting tokens][04] or after [splitting tokens][06]. A `BlindedSignature` is also called a `promise`.

```json
{
  "amount": int,
  "C_": hex_str,
  "id": str | None
}
```

`amount` is the value of the blinded token, `C_` is the blinded signature on the secret message `B_` sent in the previous step. `id` is the [keyset id][02] of the mint public keys that signed the token. It can be omitted in custom applications where mint keys are never expected to rotate.

### `Proof`

A `Proof` is sent to `Bob` for [melting tokens][05]. A [serialized](#serialization-of-tokens) `Proof` can also be sent from `Alice` to `Carol`. Upon receiving the token, `Carol` deserializes it and requests a [split][06] from `Bob` to receive new tokens. 

```json
{
  "amount": int, 
  "secret": str,
  "C": hex_str,
  "id": str | None,
}
```

`amount` is the value of the `Proof`, `secret` is the secret message (no encoding standard), `C` is the unblinded signature on `secret` (hex string), `id` is the [keyset id][02] of the mint public keys that signed the token (string).

### `Proofs`

An array (list) of `Proof`s. In general, this will be used for most operations instead of a single `Proof`. `Proofs` must be serialized before sending between wallets (see [Serialization of tokens](#serialization-of-tokens)).

## 0.2 - Methods

### Serialization of tokens

Wallets serialize tokens in a `base64_urlsafe` format (base64 encoding with `/` replaced by `_` and `+` by `-`). There are multiple token formats. Wallets are expected to support those that aren't market as deprecated. Serialized tokens have a Cashu token prefix, a versioning flag, and optionally, a URI prefix for making tokens clickable on the web.

#### 0.2.1 - V3 tokens

We use the following format for token serialization:

```sh
cashu[version][token_json]
```

`cashu` is the Cashu token prefix. `[version]` is a single `base64_urlsafe` character to denote the token format version (starting with `A` for the present token format). `[token_json]` is the token JSON serialized in `base64_urlsafe`. A `[token_json]` should be cleared of any whitespace before serializing.

##### Version
This token format has the `[version]` value `A`.

##### URI tags

To make Cashu tokens clickable on the web, we use the URI tags `cashu:` or `cashu://` or `web+cashu://` (for PWAs).

A serialized token with URI tag becomes 

```sh
cashu:cashuAeyJwcm9vZn...
```

##### Token format

The deserialized `token_json` is

```json
{
  "token": [
    {
      "mint": str,
      "proofs": List[Proof]
    },
    ...
  ],
  "memo": str <optional>
}
```


##### Example JSON

```json
{
  "token": [
    {
      "mint": "https://8333.space:3338",
      "proofs": [
        {
          "id": "9bb9d58392cd823e",
          "amount": 2,
          "secret": "EhpennC9qB3iFlW8FZ_pZw",
          "C": "02c020067db727d586bc3183aecf97fcb800c3f4cc4759f69c626c9db5d8f5b5d4"
        },
        {
          "id": "9bb9d58392cd823e",
          "amount": 8,
          "secret": "TmS6Cv0YT5PU_5ATVKnukw",
          "C": "02ac910bef28cbe5d7325415d5c263026f15f9b967a079ca9779ab6e5c2db133a7"
        }
      ]
    }
  ],
  "memo": "Thank you."
}
```

When serialized, this becomes:
```
cashuAeyJ0b2tlbiI6W3sibWludCI6Imh0dHBzOi8vODMzMy5zcGFjZTozMzM4IiwicHJvb2ZzIjpbeyJpZCI6IkRTQWw5bnZ2eWZ2YSIsImFtb3VudCI6Miwic2VjcmV0IjoiRWhwZW5uQzlxQjNpRmxXOEZaX3BadyIsIkMiOiIwMmMwMjAwNjdkYjcyN2Q1ODZiYzMxODNhZWNmOTdmY2I4MDBjM2Y0Y2M0NzU5ZjY5YzYyNmM5ZGI1ZDhmNWI1ZDQifSx7ImlkIjoiRFNBbDludnZ5ZnZhIiwiYW1vdW50Ijo4LCJzZWNyZXQiOiJUbVM2Q3YwWVQ1UFVfNUFUVktudWt3IiwiQyI6IjAyYWM5MTBiZWYyOGNiZTVkNzMyNTQxNWQ1YzI2MzAyNmYxNWY5Yjk2N2EwNzljYTk3NzlhYjZlNWMyZGIxMzNhNyJ9XX1dLCJtZW1vIjoiVGhhbmsgeW91LiJ9
```

[00]: 00.md
[01]: 01.md
[02]: 02.md
[03]: 03.md
[04]: 04.md
[05]: 05.md
[06]: 06.md
[07]: 07.md
[08]: 08.md
[09]: 09.md
[10]: 10.md
[11]: 11.md
[12]: 12.md
[13]: 13.md
[14]: 14.md
[15]: 15.md
[16]: 16.md
[17]: 17.md
[18]: 18.md
[19]: 19.md
[20]: 20.md