# AC-05: Melt Transaction

`mandatory`

---

Status: Stable draft
Scope: Quoting and executing melt (redeem notes for off-Mint payout)
Dependencies: AC-00, AC-01, AC-02, AC-03, NUT-23, NUT-25

Melting is a two-step process: (1) request a melt quote for an external payment, (2) provide Inputs and execute the melt. This document mirrors AC-06 structure and aligns fee-return handling with proof verification.

## 1. Supported methods

- [NUT-23][23] — bolt11 Lightning invoices
- [NUT-25][25] — bolt12 Lightning offers

## 2. Endpoints

- POST `/v1/melt/quote/{method}` — request a melt quote for a given external request and unit
- GET `/v1/melt/quote/{method}/{quote_id}` — check quote status
- POST `/v1/kvac/melt/{method}` — execute melt

Content-Type: application/json

## 3. Request/Response: Melt Quote

### 3.1 Request (quote)

```http
POST https://mint.host:3338/v1/melt/quote/{method}
```

Body (baseline):
```json
{
  "request": "<str>",
  "unit": "<str_enum[UNIT]>"
}
```

### 3.2 Response (quote)

```json
{
  "quote": "<str>",
  "amount": <int>,
  "unit": "<str_enum[UNIT]>",
  "state": "<UNPAID|PENDING|PAID>",
  "expiry": <int>,
  "change": {
    "fee_return": [<int>, <int>],
    "outputs": [<Output>, ...],
    "issued_macs": ["<hex-pubkey>", ...],
    "issuance_proofs": ["<cashu_kvac::models::ZKP>", ...]
  }
}
```

Semantics:
- `amount`/`unit` are what the wallet must provide as Inputs, including estimated network fees.
- `state` ∈ {UNPAID, PENDING, PAID}.
- When `state == PAID`, `change` MUST be present and include Outputs and signatures for any returned amount.
- `fee_return` is optional; if present, it is `[index_of_tweaked_output, amount_added]`.

## 4. Fee Return Handling

After the external payment is executed, if actual network fees are less than estimated:

```
overpaid_network_fees = quote_amount - network_fees - keyset_fees
```

- If `overpaid_network_fees < 0`, abort this step (never subtract from outputs).
- Otherwise, tweak one output’s amount commitment by `overpaid_network_fees`:

```rust
outputs[last].commitments[0].tweak_amount(cashu_kvac::secp::TWEAK_KIND::AMOUNT, overpaid_network_fees);
```

- Set `fee_return = [last, overpaid_network_fees]`.
- IMPORTANT: Mint MUST compute MACs and IssuanceProofs AFTER applying this tweak, or proofs will not validate.

## 5. Request: Execute Melt

```http
POST https://mint.host:3338/v1/kvac/melt/{method}
```

Body `MeltRequest` (baseline):
```json
{
  "quote": "<string>",
  "inputs": [<Input>, ...],
  "outputs": [<Output>, ...],
  "balance_proof": "<cashu_kvac::models::ZKP>",
  "mac_proofs": ["<cashu_kvac::models::ZKP>", ...],
  "range_proof": "<cashu_kvac::models::RangeZKP>"
}
```

Constraints:
- inputs.len() > 0
- All Inputs/Outputs MUST share the same `unit`.
- Each Output’s `id` MUST be an active keyset.
- Transcript ordering for proofs MUST match the Mint.

Balance constraint (delta):
- Let `fees = sum(input_fees)` per AC-02.
- Let `amount = quote_amount`.
- The BalanceProof MUST verify with `delta = (amount + fees)` NEGATED, i.e.:

```text
inputs - outputs == -(amount + fees)
```

This ensures the Outputs encode (amount + fees) less than Inputs.

## 6. Mint Verification

1) Quote checks: `quote` exists, unpaid/valid; for methods with external payment, this call may block until success/failure.
2) Unit/keyset checks: single-unit, Outputs reference active keysets.
3) Script verification: per NUT-11/14 for each Input.
4) Nullifier checks: reject if already seen.
5) Transcript init: `CashuTranscript::new()`.
6) Verify MacProofs: one per Input.
7) Verify RangeProof: for Outputs’ amount commitments.
8) Verify BalanceProof with `delta = - (amount + fees)`.
9) If overpaid network fees occurred, tweak Output commitment as in §4, then issue MACs and IssuanceProofs for all Outputs.

## 7. Response

On success, the Mint returns the payment `state` and, if applicable, the method-specific proof of payment and change outputs:

```json
{
  "state": "<UNPAID|PENDING|PAID>",
  "change": {
    "fee_return": [<int>, <int>],
    "outputs": [<Output>, ...],
    "issued_macs": ["<hex-pubkey>", ...],
    "issuance_proofs": ["<cashu_kvac::models::ZKP>", ...]
  }
}
```

## 8. Errors

- 400 Bad Request — malformed request, mixed units, proof length mismatch
- 403 Forbidden — script policy violation
- 409 Conflict — nullifier already seen, invalid quote state
- 422 Unprocessable Entity — inactive/unknown keyset id, invalid proofs
- 429 Too Many Requests — Mint policy
- 5xx Internal Server Error

## 9. Settings

Advertised in [NUT-06][06] under key `AC5`:

```json
{
  "AC5": {
    "methods": [
      <MeltMethodSetting>,
      ...
    ],
    "disabled": <bool>
  }
}
```

`MeltMethodSetting`:
```json
{
  "method": "<str>",
  "unit": "<str>",
  "min_amount": "<int|null>",
  "max_amount": "<int|null>",
  "options": "<Object|null>"
}
```

## 10. Security and Policy Notes

- Calls may block while external payment executes; clients SHOULD use long/disabled timeouts.
- Do not subtract from Outputs on fee reconciliation; only add and re-sign.
- Clients SHOULD refresh active keysets before constructing Outputs.
- Avoid reusing tags within a batch; ensure strong randomness.

[AC-00]: AC00.md
[AC-01]: AC01.md
[AC-02]: AC02.md
[AC-03]: AC03.md
[06]: 06.md
[23]: 23.md
[25]: 25.md
