# NUT-05: Melting tokens

`mandatory`

---

Melting is the process by which a client redeems coins for an off-Mint payout. Like minting, melting is a two-step process: requesting a melt quote and melting coins. This document describes the general flow that applies to all payment methods, with specifics for each supported payment method provided in dedicated method-specific NUTs.

## Supported methods

Method-specific NUTs describe how to handle different payment methods. The currently specified models are:

- [NUT-23][23] for bolt11 Lightning invoices
- [NUT-25][25] for bolt12 Lightning offers

## General Flow

The melting process follows these steps for all payment methods:

1. The wallet requests a melt quote for a `request` it wants paid by the mint, specifying the payment `method` and the `unit` the wallet would like to spend
2. The mint responds with a quote that includes a `quote` id and an `amount` demanded in the requested unit
3. The wallet sends a melting request including the `quote` id and provides `inputs` of the required amount
4. The mint executes the payment and responds with the payment `state` and any method-specific proof of payment

## Common Request and Response Formats

### Requesting a Melt Quote

To request a melt quote, the wallet of `Alice` makes a `POST /v1/melt/quote/{method}` request where `method` is the payment method requested (e.g., `bolt11`, `bolt12`, etc.).

```http
POST https://mint.host:3338/v1/melt/quote/{method}
```

Depending on the payment method, the request structure may vary, but all methods will include at minimum:

```json
{
  "request": <str>,
  "unit": <str_enum[UNIT]>
  // Additional method-specific fields will be required
}
```

The mint `Bob` responds with a quote that includes some common fields for all methods:

```json
{
  "quote": <str>,
  "amount": <int>,
  "unit": <str_enum[UNIT]>,
  "state": <str_enum[STATE]>,
  "expiry": <int>,
  "change": <MeltChange>
  // Additional method-specific fields will be included
}
```

Where `quote` is the quote ID, `amount` and `unit` the amount and unit that need to be provided (including estimated network fees), and `expiry` is the Unix timestamp until which the melt quote is valid.

`state` is an enum string field with possible values `"UNPAID"`, `"PENDING"`, `"PAID"`:

- `"UNPAID"` means that the request has not been paid yet.
- `"PENDING"` means that the request is currently being paid.
- `"PAID"` means that the request has been paid successfully.

`change` is an optional structured field of type `MeltChange` containing the outputs of the operation:
```json
{
    "fee_return": [<int>, <int>],
    "outputs": [<Output>, ...],
    "issued_macs": [<hex-pubkey>, ...],
    "issuance_proofs": [<cashu_kvac::models::ZKP>, ...]
}
```

Where all the fields except `fee_return` have the same function as in [AC-03](AC03) and are issued after the same verification steps described in it. The key difference is that `-(amount + keyset_fees)` (NEGATIVE the `amount` plus the keyset fees) is used as the "delta" for the `BalanceProof` verification.

`fee_return` is an *optional* tuple of integers:
- the first is the index of the `Output` to which `fee_return` was added
- the second is how much was added.

After a quote is `PAID`, `change` is no longer optional: the Mint **MUST** always provide outputs to the operation.

### Adding FEE RETURN to the outputs

After the payment has been processed, if the network fee is less than estimated during the melt quote step, the Mint **MUST** return the
overpaid amount, calculated as:

```
overpaid_network_fees = quote_amount - network_fees - keyset_fees
```


> [!CAUTION]
> If `overpaid_fees` is negative, this step **MUST** be abandoned: subtracting from the outputs leads to a serious security issue.


The Mint can then tweak the amount commitment of one of the outputs (by convention -- the last), adding `overpaid_fees`:

```rust
outputs[1].commitments[0].tweak_amount(cashu_kvac::secp::TWEAK_KIND::AMOUNT, overpaid_fees)
```

Then set `fee_return = [<index_of_the_tweaked_output>, overpaid_fees]`.

**ATTENTION:** The issuance of macs and related issuance proofs **MUST** be computed **AFTER** this step, otherwise they will be invalid for the tweaked output.


### Check Melt Quote State

To check whether a melt quote has been paid, the wallet makes a `GET /v1/melt/quote/{method}/{quote_id}`.

```http
GET https://mint.host:3338/v1/melt/quote/{method}/{quote_id}
```

The mint responds with the same structure as the quote response.

### Executing a Melt Quote

To execute the melting process, the wallet calls the `POST /v1/kvac/melt/{method}` endpoint.

```http
POST https://mint.host:3338/v1/kvac/melt/{method}
```

> [!IMPORTANT]
> For methods that involve external payments (like Lightning), this call may block until the payment either succeeds or fails. This can take a long time. Make sure to **use no (or a very long) timeout when making this call**!

The wallet includes the following common data in its request:

```json
{
    "quote": <string>,
    "inputs": [<Input>, ...],
    "outputs": [<Output>, ...],
    "balance_proof": <cashu_kvac::models::ZKP>,
    "mac_proofs": [<cashu_kvac::models::ZKP>, ...],
    "range_proof": <cashu_kvac::models::RangeZKP>,
    // Other method-specific options
}
```
where:

- `quote` is the quote ID from the previous step
- `inputs` are the same as in `swap_request.inputs` ([AC-03][AC-03])
- `outputs` are the same as in `swap_request.outputs` ([AC-03][AC-03])
- `balance_proof` proves that the difference `delta = inputs - outputs` is equal to **NEGATIVE** the amount in the previously generated quote. This -in English- means "the outputs encode exactly `quote.amount` more than the inputs".
- `mac_proofs` are the same as in `swap_request.mac_proofs` ([AC-03][AC-03])
- `range_proof` is the same as in `swap_request.range_proof` ([AC-03][AC-03])


## Settings

The mint's settings for this NUT indicate the supported method-unit pairs for melting. They are part of the info response of the mint ([NUT-06][06]):

```json
{
  "AC5": {
    "methods": [
      <MeltMethodSetting>,
      ...
    ],
    "disabled": <bool>
  }
}
```

`MeltMethodSetting` indicates supported `method` and `unit` pairs and additional settings of the mint. `disabled` indicates whether melting is disabled.

`MeltMethodSetting` is of the form:

```json
{
  "method": <str>,
  "unit": <str>,
  "min_amount": <int|null>,
  "max_amount": <int|null>,
  "options": <Object|null>
}
```

`min_amount` and `max_amount` indicate the minimum and maximum amount for an operation of this method-unit pair. `options` are method-specific and can be defined in method-specific NUTs.

[00]: 00.md
[01]: 01.md
[02]: 02.md
[03]: 03.md
[04]: 04.md
[05]: 05.md
[06]: 06.md
[07]: 07.md
[08]: 08.md
[09]: 09.md
[10]: 10.md
[11]: 11.md
[12]: 12.md
[23]: 23.md
[25]: 25.md
[AC03]: AC03.md
