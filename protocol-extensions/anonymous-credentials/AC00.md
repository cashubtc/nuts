# AC-00: Introduction and Core Models

`mandatory`

---

Status: Stable draft
Scope: Shared data models used by AC-01/02/03/04/05/06
Dependencies: cashu-kvac (KVAC), NUT-01/02/10/11/14

This document defines the core data models and normative constraints used by the Anonymous Credentials (AC) extensions. It mirrors the sectioning and constraint style used in AC-06 to improve clarity and conformance.

## 1. Overview

[cashu-kvac][KVAC] is treated as a black-box implementation of the cryptographic operations for Anonymous Credentials. This specification does not reproduce cryptographic details; instead it defines how objects are constructed, serialized, and validated between wallet and Mint.

Terminology differences from the main specs:
- proof → note: the word “proof” refers to zero-knowledge proofs in this spec, so we use “note” for value-bearing objects.
- Mint (capital M) refers to the server component.
- JSON examples may embed symbolic types like `cashu_kvac::{Struct}` to indicate binary-encoded KVAC types.

## 2. Keys

### 2.1 Mint Private Key

Rust (illustrative only; use deterministic derivation in production):

```rust
let scalars = (0..6).map(|_| cashu_kvac::secp::Scalar::random()).collect();
let mint_privkey = cashu_kvac::models::MintPrivateKey::from_scalars(&scalars).unwrap();
```

### 2.2 Mint Public Key

```rust
let mint_pubkey: cashu_kvac::models::MintPublicKey = mint_privkey.public_key.clone();
```

Constraints:
- Public keys MUST be compressed Secp256k1 format (33-byte, hex-encoded for wire) per AC-01/NUT-02.
- A keyset contains exactly one MintPublicKey (internally composed of two points, e.g., `Cw` and `I`).

## 3. Data Models

All hex strings are lowercase, no `0x` prefix, unless otherwise noted.

### 3.1 UnsignedNote

A client-created note not yet signed by the Mint.

```json
{
  "keyset_id": "<hex>",
  "amount": 1337,
  "script": "<bytes-as-hex|null>",
  "unit": "sat",
  "tag": "<64-hex>",
  "attributes": [
    "<cashu_kvac::models::AmountAttribute>",
    "<cashu_kvac::models::ScriptAttribute>"
  ]
}
```

Constraints:
- keyset_id: hex-encoded keyset identifier (see AC-02/NUT-02). MUST correspond to an active keyset when used to request Mint signatures.
- amount: non-negative integer. For zero-amount bootstrap notes, see AC-06.
- script: optional NUT-10 script, serialized as bytes and hex-encoded.
- unit: currency unit string (e.g., "sat", "msat"). All Inputs/Outputs within one request MUST share the same unit.
- tag: 32-byte random scalar serialized as 64-hex. MUST be unique per request and SHOULD be globally unique.
- attributes: tuple of AmountAttribute and ScriptAttribute constructed by the client.

Example attribute creation:

```rust
let amount_attr = cashu_kvac::models::AmountAttribute::new(1337, Some("deadbeefdeadbeefdeadbeefdeadbeef"));
let script_attr = cashu_kvac::models::ScriptAttribute::new(b"", Some("baadc0debaadc0debaadc0debaadc0de"));
```

### 3.2 Output

The Mint-visible view of an UnsignedNote.

```json
{
  "id": "<keyset_id>",
  "tag": "<64-hex>",
  "commitments": ["<66-hex>", "<66-hex>"]
}
```

Constraints:
- id MUST equal `unsigned_note.keyset_id`.
- commitments[0] is the amount commitment; commitments[1] is the script commitment.
- The pair (id, tag) SHOULD be unique in any single request.

### 3.3 MAC

A Mint signature over Output commitments and tag.

```rust
let mac = MAC::generate(
    &mint_privkey,
    &output.commitments.0,
    Some(&output.commitments.1),
    Some(output.tag),
);
```

### 3.4 Note (signed)

```json
{
  "keyset_id": "<hex>",
  "amount": 1337,
  "script": "<hex|null>",
  "unit": "sat",
  "tag": "<64-hex>",
  "mac": "<66-hex>",
  "attributes": [
    "<cashu_kvac::AmountAttribute>",
    "<cashu_kvac::ScriptAttribute>"
  ],
  "issuance_proof": "<cashu_kvac::ZKP>"
}
```

Constraints:
- Fields mirror UnsignedNote.
- `issuance_proof` MUST verify against the MintPublicKey for `keyset_id`.

### 3.5 Input

Derived from a Note to spend it.

```json
{
  "id": "<keyset_id>",
  "script": "<hex|null>",
  "randomized_commitments": "<cashu_kvac::RandomizedCommitments>",
  "witness": "<hex|null>"
}
```

Construction:

```rust
let randomized_commitments = cashu_kvac::models::RandomizedCommitments::from_attributes_and_mac(
    &note.attributes.0,
    Some(&note.attributes.1),
    note.tag,
    note.mac,
    true,
);
```

Constraints:
- id MUST equal `note.keyset_id`.
- witness/script handling per NUT-10/11/14.

## 4. Identifiers

- Mint identifies Inputs by `input.randomized_commitments.Cv` (nullifier base) and Outputs by `output.tag`.
- Clients identify Notes/UnsignedNotes by `tag`.

## 5. Validation and Interop Rules

- All amounts within a single request MUST be expressed in the same `unit`.
- Keyset ids used for Outputs MUST refer to active keysets (see AC-01/AC-02) at the time of issuance.
- Tags SHOULD be unique per request to avoid ambiguity and replay within the same batch.

## 6. Security and Policy Notes

- For deterministic wallets (see AC-07), `tag` and attribute blinding factors SHOULD be derived per AC-07 to allow recovery. When deterministic mode is used, clients MUST ensure counters are allocated per-output and not reused.
- Tags and blinding factors MUST be generated with cryptographically secure randomness.
- Scripts (NUT-10) may reveal spending policy to the Mint via commitments; avoid embedding sensitive metadata.
- IssuanceProof verification MUST use the correct MintPublicKey derived from the stated keyset id.
- Nullifier reuse is prevented by the Mint; clients SHOULD treat spent Notes as invalid after a successful swap.

[AC-01]: AC01.md
[AC-02]: AC02.md
[AC-03]: AC03.md
[AC-06]: AC06.md
[KVAC]: https://github.com/lollerfirst/cashu-kvac.git
[01]: 01.md
[10]: 10.md
[11]: 11.md
[14]: 14.md
[02]: 02.md
