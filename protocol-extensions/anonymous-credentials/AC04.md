# AC-04: Mint Transaction

`mandatory`

---

Minting notes is a two-step process: requesting a mint quote and minting new notes. This document describes the general flow that applies to all payment methods, with specifics for each supported payment method provided in dedicated NUTs.

## Supported methods

Method-specific NUTs describe how to handle different payment methods. The currently specified models are:

- [NUT-23][23] for bolt11 Lightning invoices

## General Flow

The minting process follows these steps for all payment methods:

1. The wallet requests a mint quote for the `unit` to mint, specifying the payment `method`.
2. The mint responds with a quote that includes a `quote` id and a payment `request`.
3. The user pays the `request` using the specified payment method.
4. The wallet then requests minting of new notes with the mint, including the `quote` id and new `outputs`.
5. The mint verifies payment and returns blind signatures.

## Common Request and Response Formats

### Requesting a Mint Quote

To request a mint quote, a wallet makes a `POST /v1/mint/quote/{method}` request where `method` is the payment method requested (e.g., `bolt11`, `bolt12`, etc.).

```http
POST https://mint.host:3338/v1/mint/quote/{method}
```

Depending on the payment method, the request structure may vary, but all methods will include at minimum:

```json
{
  "unit": <str_enum[UNIT]>
  // Additional method-specific fields may be required
}
```

The Mint responds with a quote that includes some common fields for all methods:

```json
{
  "quote": <str>,
  "request": <str>,
  "unit":  <str_enum[UNIT]>,
  // Additional method-specific fields will be included
}
```

Where `quote` is the quote ID, `request` is the payment request for the quote, and `unit` corresponds to the value provided in the request.

> [!CAUTION]
>
> `quote` is a **unique and random** id generated by the mint to internally look up the payment state. `quote` **MUST** remain a secret between user and mint and **MUST NOT** be derivable from the payment request. A third party who knows the `quote` ID can front-run and steal the notes that this operation mints. To prevent this, use [NUT-20][20] locks to enforce public key authentication during minting.

### Check Mint Quote State

To check whether a mint quote has been paid, the wallet makes a `GET /v1/mint/quote/{method}/{quote_id}`.

```http
GET https://mint.host:3338/v1/mint/quote/{method}/{quote_id}
```

The mint responds with the same structure as the initial quote response.

### Executing a Mint Quote

After requesting a mint quote and paying the request, the wallet proceeds with minting new notes by calling the `POST /v1/kvac/mint/{method}` endpoint.

```http
POST https://mint.host:3338/v1/kvac/mint/{method}
```

The wallet sends a `MintRequest` with the following payload:

```json
{
    "quote": <string>,
    "inputs": [<Input>, ...],
    "outputs": [<Output>, ...],
    "balance_proof": <cashu_kvac::models::ZKP>,
    "mac_proofs": [<cashu_kvac::models::ZKP>, ...],
    "range_proof": <cashu_kvac::models::RangeZKP>,
}
```

where:
* `quote` is the quote ID from the previous step
* `inputs` are the same as in `swap_request.inputs` ([AC-03][AC-03])
* `outputs` are the same as in `swap_request.outputs` ([AC-03][AC-03])
* `balance_proof` proves that the difference `delta = inputs - outputs` is equal to **NEGATIVE** the amount in the previously generated quote. This -in English- means "the outputs encode exactly `quote.amount` more than the inputs".
* `mac_proofs` are the same as in `swap_request.mac_proofs` ([AC-03][AC-03])
* `range_proof` is the same as in `swap_request.range_proof` ([AC-03][AC-03])

The mint then responds with `MintResponse`, which is exactly the same as `SwapResponse` ([AC-03][AC-03]):

```json
{
    "outputs": [<Output>, ...],
    "issued_macs": [<hex-pubkey>, ...],
    "issuance_proofs": [<cashu_kvac::models::ZKP>, ...]
}
```

The wallet can then follow step 7 in [AC-03][AC-03] to obtain `Note`s from `response.outputs`.

## Adding New Payment Methods

To add a new payment method (e.g., BOLT12), implement the following:

1. Define the method-specific request and response structures following the pattern above
2. Implement the three required endpoints: quote request, quote check, and mint execution
3. Update the settings to include the new method

## Settings

The settings for this NUT indicate the supported method-unit pairs for minting. They are part of the info response of the mint ([NUT-06][06]) which reads:

```json
{
  "4": {
    "methods": [
      <MintMethodSetting>,
      ...
    ],
    "disabled": <bool>
  }
}
```

`MintMethodSetting` indicates supported `method` and `unit` pairs and additional settings of the mint. `disabled` indicates whether minting is disabled.

`MintMethodSetting` is of the form:

```json
{
  "method": <str>,
  "unit": <str>,
  "min_amount": <int|null>,
  "max_amount": <int|null>,
  "options": <Object|null>
}
```

`min_amount` and `max_amount` indicate the minimum and maximum amount for an operation of this method-unit pair. `options` are method-specific and can be defined in method-specific NUTs.

[00]: 00.md
[01]: 01.md
[02]: 02.md
[03]: 03.md
[04]: 04.md
[05]: 05.md
[06]: 06.md
[07]: 07.md
[08]: 08.md
[09]: 09.md
[10]: 10.md
[11]: 11.md
[12]: 12.md
[20]: 20.md
[23]: 23.md
[AC-03]: AC03.md
