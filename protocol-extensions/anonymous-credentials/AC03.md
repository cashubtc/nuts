# AC-03: Swap Transaction

`mandatory`

---

Status: Stable draft
Scope: Spend existing Notes (Inputs) to obtain signatures on new UnsignedNotes (Outputs)
Dependencies: AC-00, AC-01, AC-02, NUT-10/11/14

This document describes the process by which a client presents signed `Note`s as Inputs and obtains Mint signatures on new `UnsignedNote`s as Outputs, subject to correctness and fee policy.

## 1. Endpoint

- Method: POST
- Path: `/v1/kvac/swap`
- Content-Type: application/json

## 2. Request

The client sends a `SwapRequest`:

```json
{
  "inputs": [<Input>, ...],
  "outputs": [<Output>, ...],
  "balance_proof": "<cashu_kvac::models::ZKP>",
  "mac_proofs": ["<cashu_kvac::models::ZKP>", ...],
  "range_proof": "<cashu_kvac::models::RangeZKP>"
}
```

Constraints:
- inputs.len() == 2 (exactly two inputs required)
- outputs.len() == 2 (exactly two outputs required)
- mac_proofs.len() == 2
- All Inputs/Outputs within the request MUST share the same `unit` (see AC-00).
- Each `outputs[i].id` MUST correspond to an active keyset (AC-01/AC-02).
- Tags SHOULD be unique within the request; duplicate tags across Outputs SHOULD be avoided.
- Transcript ordering for proofs MUST be consistent between client and Mint (see §3).

Decoy shaping rules:
- If the wallet has fewer than two Inputs, it SHOULD obtain zero-amount Notes from [AC-06] and include them as decoy Inputs.
- If the wallet has fewer than two Outputs, it SHOULD include a decoy Output encoding amount 0. The decoy Output MUST be covered by the RangeProof like any other Output.
## 3. Mint Verification

Upon receiving `SwapRequest`, the Mint performs:

1) Unit and keyset checks
- Verify single-unit consistency across all Inputs/Outputs.
- Verify each Output’s keyset id is active.

2) Script verification
- For each Input, extract `script`/`witness` if present and verify per [NUT-11] or [NUT-14].
- Reject on policy failure.

3) Nullifier checks
- Derive nullifier from `input.randomized_commitments.Cv`.
- Reject if nullifier already seen (double-spend).

4) Initialize transcript

```rust
let mut transcript = cashu_kvac::transcript::CashuTranscript::new();
```

5) Verify MacProofs (one per Input)

```rust
cashu_kvac::kvac::MacProof::verify(
    &mint_privkeys[input.id],
    &input.randomized_commitments,
    &input.script, // None if no script
    mac_proof,
    &mut transcript,
);
```

6) Verify RangeProof for Outputs

```rust
let amount_commitments: Vec<GroupElement> = outputs.iter().map(|o| o.commitments.0).collect();
cashu_kvac::kvac::RangeProof::verify(&mut transcript, &amount_commitments, range_proof);
```

7) Verify BalanceProof

- Let `delta` be the fee-adjusted difference. For no-fee keysets, `delta = 0`.
- With per-input fees (see AC-02), `delta = sum(input_fees)`.

```rust
cashu_kvac::kvac::BalanceProof::verify(
    &inputs_randomized_commitments,
    &outputs_amount_commitments,
    delta as i64,
    balance_proof,
    &mut transcript,
);
```

Reject if any verification fails.

## 4. Response

`SwapResponse`:

```json
{
  "outputs": [<Output>, ...],
  "issued_macs": ["<hex-pubkey>", ...],
  "issuance_proofs": ["<cashu_kvac::models::ZKP>", ...]
}
```

- `issued_macs[i]` and `issuance_proofs[i]` correspond to `outputs[i]`.

## 5. Client Verification and Note Assembly

For each (`UnsignedNote`, `MAC`, `IssuanceProof`) triple:

```rust
cashu_kvac::kvac::IssuanceProof::verify(
    &mint_pubkey,                 // derived from outputs[i].id via AC-01/02
    unsigned_note.tag,
    mac,
    &unsigned_note.attributes.0,  // amount attribute
    Some(&unsigned_note.attributes.1),
    issuance_proof.clone(),
);
```

If verification succeeds, the wallet combines `UnsignedNote`, `MAC`, and `IssuanceProof` into a `Note` (AC-00).

## 6. Errors

- 400 Bad Request
  - Empty `inputs`/`outputs`
  - Length mismatch (`inputs` vs `mac_proofs`)
  - Malformed data or proof encoding
  - Mixed units
- 403 Forbidden
  - Script policy violation (NUT-11/14 verification failed)
- 409 Conflict
  - Nullifier already seen (double-spend)
- 422 Unprocessable Entity
  - Inactive/unknown keyset id
  - Invalid MacProof, RangeProof, or BalanceProof
- 5xx Internal Server Error
  - Server-side failures

## 7. Security and Policy Notes

- Proof ordering in the transcript MUST be identical between client and Mint.
- Keyset rotation: wallets SHOULD fetch active keysets before constructing Outputs.
- Fee policy: clients MUST match Mint rounding/fee policy for `delta`.
- Privacy: avoid reusing tags; keep scripts minimal to policy needs.

[AC-00]: AC00.md
[AC-01]: AC01.md
[AC-02]: AC02.md
[11]: 11.md
[14]: 14.md
