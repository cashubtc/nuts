# NUT-05: Melting tokens

`mandatory`

---

Melting tokens allows wallets to convert ecash into external payments executed by the mint. Similar to minting tokens, melting is a two-step process: requesting a melt quote and performing the melt.

1. **Requesting a Melt Quote**  
   The wallet **MUST** request a melt quote by specifying the `request` to be paid and the `unit` to be used for payment. The mint responds with a `quote` ID, the required `amount`, and, for specific methods like `bolt11`, a `fee_reserve` for payment fees.

2. **Performing the Melt**  
   After obtaining the quote, the wallet **MUST** submit the `quote` ID and `inputs` that meet or exceed the required total (`amount + fee_reserve`). If applicable, the wallet may include `outputs` to handle overpaid fees. The mint responds with the payment `state`, and if successful, includes a `payment_preimage`.

---

## Melt Quote

To request a melt quote, the wallet sends a `POST /v1/melt/quote/{method}` request. The `method` specifies the payment method (e.g., `bolt11`).

### Request Endpoint

```http
POST https://mint.host:3338/v1/melt/quote/{method}
```

### Request Body

The wallet **MUST** include:

```json
{
  "request": <str>,
  "unit": <str>,
  "opts": <obj|null>
}
```

- `request`: The payment request to be fulfilled by the mint.
- `unit`: The unit for the payment (e.g., "sat").
- `opts`: Options specific to the payment method.

### Response

The mint **MUST** respond with:

```json
{
  "quote": <str>,
  "amount": <int>,
  "fee_reserve": <int|null>,
  "state": <str_enum[STATE]>,
  "expiry": <int|null>,
  "opts": <obj|null>
}
```

- `quote`: A unique ID for the quote.
- `amount`: The amount required for payment.
- `fee_reserve`: An additional reserve for fees (if applicable).
- `state`: Current state of the quote (`UNPAID`, `PENDING`, or `PAID`).
- `expiry`: Expiration timestamp for the quote (or `null` if it does not expire).
- `opts`: Options specific to the payment method.

The wallet **MUST** store the `quote` ID and the required `amount` for use in subsequent melt operations.

---

### Example: Requesting a Melt Quote

**Request:**

```bash
curl -X POST https://mint.host:3338/v1/melt/quote/{method} -d \
'{
  "request": "lnbc100n1p3kdrv5sp5lpdxzghe5j67q...",
  "unit": "sat"
}'
```

**Response:**

```json
{
  "quote": "TRmjduhIsPxd...",
  "amount": 10,
  "fee_reserve": 2,
  "state": "UNPAID",
  "expiry": 1701704757
}
```

---

## Checking Melt Quote State

To check the state of a melt quote, the wallet **MUST** send a `GET /v1/melt/quote/{method}/{quote_id}` request.

### Request Endpoint

```http
GET https://mint.host:3338/v1/melt/quote/{method}/{quote_id}
```

### Response

The mint **MUST** return the same fields as in the `PostMeltQuoteResponse`.

---

### Example: Checking Melt Quote State

**Request:**

```bash
curl -X GET https://mint.host:3338/v1/melt/quote/{method}/{quote_id}
```

**Response:**

```json
{
  "quote": "TRmjduhIsPxd...",
  "amount": 10,
  "fee_reserve": 2,
  "state": "UNPAID",
  "expiry": 1701704757
}
```

---

## Melting Tokens

After obtaining a valid melt quote, the wallet **MUST** call `POST /v1/melt/{method}` to perform the melt.

### Request Endpoint

```http
POST https://mint.host:3338/v1/melt/{method}
```

⚠️ **Note:** This call blocks until the payment succeeds or fails. Ensure appropriate timeout handling when making this call.

### Request Body

The wallet **MUST** include:

```json
{
  "quote": <str>,
  "inputs": <Array[Proof]>
}
```

- `quote`: The melt quote ID.
- `inputs`: Proofs with a total value meeting or exceeding `amount + fee_reserve`.

### Response

The mint **MUST** respond with:

```json
{
  "quote": <str>,
  "state": <str_enum[STATE]>,
  "opts": <obj|null>
}
```

- `quote`: The quote ID.
- `state`: The current state (`PAID` indicates success).
- `opts`: Options specific to the payment method.

---

### Example: Performing a Melt

**Request:**

```bash
curl -X POST https://mint.host:3338/v1/melt/{method} -d \
'{
  "quote": "TRmjduhIsPxd...",
  "inputs": [
    {
      "amount": 4,
      "id": "009a1f293253e41e",
      "secret": "429700b812a58436be2629af8731a31a37fce54dbf8cbbe90b3f8553179d23f5",
      "C": "03b01869f528337e161a6768b480fcf9f75fd248b649c382f5e352489fd84fd011"
    },
    {
      "amount": 8,
      "id": "009a1f293253e41e",
      "secret": "4f3155acef6481108fcf354f6d06e504ce8b441e617d30c88924991298cdbcad",
      "C": "0278ab1c1af35487a5ea903b693e96447b2034d0fd6bac529e753097743bf73ca9"
    }
  ]
}'
```

**Response:**

```json
{
  "quote": "TRmjduhIsPxd...",
  "state": "PAID",
}
```

---

## Settings

The mint's [NUT-06](06.md) settings **MUST** define supported method-unit pairs and additional constraints:

```json
{
  "5": {
    "methods": [
      <MeltMethodSetting>,
      ...
    ],
    "disabled": <bool>
  }
}
```

`MeltMethodSetting` specifies the supported payment methods and units, along with optional `min_amount` and `max_amount`:

```json
{
  "method": <str>,
  "unit": <str>,
  "min_amount": <int|null>,
  "max_amount": <int|null>
}
```

### Example: Melt Method Setting

```json
{
  "method": "bolt11",
  "unit": "sat",
  "min_amount": 100,
  "max_amount": 10000
}
```