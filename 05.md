# NUT-05: Melting tokens

`mandatory`

`used in: NUT-08, NUT-15`

---

Melting tokens is the opposite of minting tokens (see [NUT-04][04]). Like minting tokens, melting is a two-step process: requesting a melt quote and melting tokens. This document describes the general flow that applies to all payment methods, with specifics for each supported payment method provided in dedicated sections.

## General Flow

The melting process follows these steps for all payment methods:

1. The wallet requests a melt quote for a `request` it wants paid by the mint, specifying the payment `method` and the `unit` the wallet would like to spend
2. The mint responds with a quote that includes a `quote` id and an `amount` demanded in the requested unit
3. The wallet sends a melting request including the `quote` id and provides `inputs` of the required amount
4. The mint executes the payment and responds with the payment `state` and any method-specific proof of payment

## Common Request and Response Formats

### Melt Quote

To request a melt quote, the wallet of `Alice` makes a `POST /v1/melt/quote/{method}` request where `method` is the payment method requested (e.g., `bolt11`, `bolt12`, etc.).

```http
POST https://mint.host:3338/v1/melt/quote/{method}
```

Depending on the payment method, the request structure may vary, but all methods will include at minimum:

```json
{
  "unit": <str_enum[UNIT]>
  // Additional method-specific fields will be required
}
```

The mint `Bob` responds with a quote that includes some common fields for all methods:

```json
{
  "quote": <str>,
  "amount": <int>,
  "unit": <str_enum[UNIT]>,
  "state": <str_enum[STATE]>,
  "expiry": <int>
  // Additional method-specific fields will be included
}
```

Where `quote` is the quote ID, `amount` and `unit` the amount and unit that need to be provided, and `expiry` is the Unix timestamp until which the melt quote is valid.

`state` is an enum string field with possible values `"UNPAID"`, `"PENDING"`, `"PAID"`:

- `"UNPAID"` means that the request has not been paid yet.
- `"PENDING"` means that the request is currently being paid.
- `"PAID"` means that the request has been paid successfully.

### Check Melt Quote State

To check whether a melt quote has been paid, the wallet makes a `GET /v1/melt/quote/{method}/{quote_id}`.

```http
GET https://mint.host:3338/v1/melt/quote/{method}/{quote_id}
```

The mint responds with the same structure as the initial quote response.

### Melting Tokens

To execute the melting process, the wallet calls the `POST /v1/melt/{method}` endpoint.

```http
POST https://mint.host:3338/v1/melt/{method}
```

⚠️ **Attention:** For methods that involve external payments (like Lightning), this call may block until the payment either succeeds or fails. This can take quite a long time. Make sure to **use no (or a very long) timeout when making this call**!

The wallet includes the following common data in its request:

```json
{
  "quote": <str>,
  "inputs": <Array[Proof]>
  // Additional method-specific fields may be required
}
```

where `quote` is the melt quote ID and `inputs` are the proofs with a total amount sufficient to cover the requested amount plus any fees.

The mint responds with a structure that indicates the payment state and includes any method-specific proof of payment when successful.

## Payment Method: BOLT11

This section describes the specifics for the `bolt11` payment method, which uses Lightning Network invoices.

### Melt Quote - BOLT11

For the `bolt11` method, the wallet includes the following specific `PostMeltQuoteBolt11Request` data:

```json
{
  "request": <str>,
  "unit": <str_enum[UNIT]>,
  "options": { // Optional
    "amountless": {
      "amount_msat": <int>
    }
  }
}
```

Here, `request` is the bolt11 Lightning invoice to be paid and `unit` is the unit the wallet would like to pay with. The `options` field can include support for amountless invoices if supported by the mint.

The mint responds with a `PostMeltQuoteBolt11Response`:

```json
{
  "quote": <str>,
  "request": <str>,
  "amount": <int>,
  "unit": <str_enum[UNIT]>,
  "fee_reserve": <int>,
  "state": <str_enum[STATE]>,
  "expiry": <int>,
  "payment_preimage": <str|null>
}
```

Where `fee_reserve` is the additional fee reserve required for the Lightning payment. The mint expects the wallet to include `Proofs` of _at least_ `total_amount = amount + fee_reserve + fee` where `fee` is calculated from the keyset's `input_fee_ppk` as described in [NUT-02][02].

### Melting Tokens - BOLT11

For the `bolt11` method, the wallet can include an optional `outputs` field in the melt request to receive change for overpaid Lightning fees (see [NUT-08][08]):

```json
{
  "quote": <str>,
  "inputs": <Array[Proof]>,
  "outputs": <Array[BlindedMessage]> // Optional
}
```

If the `outputs` field is included and there is excess from the `fee_reserve`, the mint will respond with a `change` field containing blind signatures for the overpaid amount:

```json
{
  "quote": <str>,
  "request": <str>,
  "amount": <int>,
  "unit": <str_enum[UNIT]>,
  "fee_reserve": <int>,
  "state": <str_enum[STATE]>,
  "expiry": <int>,
  "payment_preimage": <str>,
  "change": <Array[BlindSignature]> // Present if outputs were included and there's change
}
```

### Example - BOLT11

Melt quote request:

```bash
curl -X POST https://mint.host:3338/v1/melt/quote/bolt11 -d \
'{"request": "lnbc100n1p3kdrv5sp5lpdxzghe5j67q...", "unit": "sat"}'
```

Melt quote response:

```json
{
  "quote": "TRmjduhIsPxd...",
  "request": "lnbc100n1p3kdrv5sp5lpdxzghe5j67q...",
  "amount": 10,
  "unit": "sat",
  "fee_reserve": 2,
  "state": "UNPAID",
  "expiry": 1701704757
}
```

Check quote state:

```bash
curl -X GET http://localhost:3338/v1/melt/quote/bolt11/TRmjduhIsPxd...
```

Melt request:

```bash
curl -X POST https://mint.host:3338/v1/melt/bolt11 -d \
'{"quote": "od4CN5smMMS3K3QVHkbGGNCTxfcAIyIXeq8IrfhP", "inputs": [...]}'
```

Successful melt response:

```json
{
  "quote": "TRmjduhIsPxd...",
  "request": "lnbc100n1p3kdrv5sp5lpdxzghe5j67q...",
  "amount": 10,
  "unit": "sat",
  "fee_reserve": 2,
  "state": "PAID",
  "expiry": 1701704757,
  "payment_preimage": "c5a1ae1f639e1f4a3872e81500fd028bece7bedc1152f740cba5c3417b748c1b"
}
```

## Adding New Payment Methods

To add a new payment method (e.g., BOLT12), implement the following:

1. Define the method-specific request and response structures following the pattern above
2. Implement the three required endpoints: quote request, quote check, and melt execution
3. Update the settings to include the new method
4. Document any method-specific fields or behaviors that differ from the general flow

## Settings

The mint's settings for this NUT indicate the supported method-unit pairs for melting. They are part of the info response of the mint ([NUT-06][06]):

```json
{
  "5": {
    "methods": [
      <MeltMethodSetting>,
      ...
    ],
    "disabled": <bool>
  }
}
```

`MeltMethodSetting` indicates supported `method` and `unit` pairs and additional settings of the mint. `disabled` indicates whether melting is disabled.

`MeltMethodSetting` is of the form:

```json
{
  "method": <str>,
  "unit": <str>,
  "min_amount": <int|null>,
  "max_amount": <int|null>,
  // Method-specific settings can be added here
}
```

`min_amount` and `max_amount` indicate the minimum and maximum amount for an operation of this method-unit pair.

Example `MeltMethodSetting` for BOLT11:

```json
{
  "method": "bolt11",
  "unit": "sat",
  "min_amount": 100,
  "max_amount": 10000,
  "amountless": true
}
```

[00]: 00.md
[01]: 01.md
[02]: 02.md
[03]: 03.md
[04]: 04.md
[05]: 05.md
[06]: 06.md
[07]: 07.md
[08]: 08.md
[09]: 09.md
[10]: 10.md
[11]: 11.md
[12]: 12.md